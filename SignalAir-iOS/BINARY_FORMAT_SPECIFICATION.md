# äºŒé€²åˆ¶ç·¨ç¢¼å™¨/è§£ç¢¼å™¨æ ¼å¼è¦ç¯„

## ğŸ”§ å”è­°å¸¸æ•¸
- **å”è­°ç‰ˆæœ¬**: 1 (UInt8)
- **æœ€å°é ­éƒ¨å¤§å°**: 10 bytes
- **æœ€å¤§IDé•·åº¦**: 64 bytes
- **æœ€å¤§å­—ç¬¦ä¸²é•·åº¦**: 64 bytes

## ğŸ“¦ æ¨™æº– MeshMessage æ ¼å¼

### ç·¨ç¢¼æ ¼å¼ (BinaryMessageEncoder.encode)
```
åç§»é‡  å¤§å°     æè¿°                         æ ¼å¼
------  ----     ----                         ----
0       1 byte   å”è­°ç‰ˆæœ¬                     UInt8 (å›ºå®šå€¼: 1)
1       1 byte   è¨Šæ¯é¡å‹                     UInt8 (MeshMessageType.rawValue)
2       1 byte   è¨Šæ¯IDé•·åº¦                   UInt8 (1-64)
3       N bytes  è¨Šæ¯ID                       UTF-8å­—ç¬¦ä¸²
3+N     4 bytes  æ•¸æ“šé•·åº¦                     UInt32 (Little Endian)
7+N     4 bytes  æ™‚é–“æˆ³                       UInt32 (Little Endian, Unixæ™‚é–“)
11+N    M bytes  å¯¦éš›æ•¸æ“š                     åŸå§‹æ•¸æ“š
```

### è§£ç¢¼æµç¨‹ (BinaryMessageDecoder.decode)
1. **é©—è­‰å”è­°ç‰ˆæœ¬**: å¿…é ˆç‚º 1
2. **è§£æè¨Šæ¯é¡å‹**: å¿…é ˆæ˜¯æœ‰æ•ˆçš„ MeshMessageType
3. **è®€å–ID**: 
   - è®€å–IDé•·åº¦ (1-64 bytes)
   - è®€å–IDå…§å®¹ä¸¦æ­£è¦åŒ– (ç§»é™¤$å‰ç¶´ï¼Œé©—è­‰UUIDæ ¼å¼)
4. **è®€å–æ•¸æ“šé•·åº¦**: 4 bytes, Little Endian
5. **è®€å–æ™‚é–“æˆ³**: 4 bytes, Little Endian
6. **è®€å–å¯¦éš›æ•¸æ“š**: æ ¹æ“šæ•¸æ“šé•·åº¦è®€å–

## ğŸ’¬ èŠå¤©è¨Šæ¯æ ¼å¼

### ChatViewModel ç·¨ç¢¼æ ¼å¼ (encodeChatMessageToBinary)
```
åç§»é‡  å¤§å°     æè¿°                         æ ¼å¼
------  ----     ----                         ----
0       4 bytes  æ™‚é–“æˆ³                       UInt32 (Little Endian)
4       1 byte   è¨­å‚™åç¨±é•·åº¦                 UInt8
5       N bytes  è¨­å‚™åç¨±                     UTF-8å­—ç¬¦ä¸²
5+N     1 byte   è¨Šæ¯IDé•·åº¦                   UInt8
6+N     M bytes  è¨Šæ¯ID                       UTF-8å­—ç¬¦ä¸²
6+N+M   2 bytes  è¨Šæ¯å…§å®¹é•·åº¦                 UInt16 (Little Endian)
8+N+M   P bytes  è¨Šæ¯å…§å®¹                     UTF-8å­—ç¬¦ä¸²
```

### BinaryMessageEncoder.encodeChatMessage æ ¼å¼
```
åç§»é‡  å¤§å°     æè¿°                         æ ¼å¼
------  ----     ----                         ----
0       1 byte   å”è­°ç‰ˆæœ¬                     UInt8 (å›ºå®šå€¼: 1)
1       1 byte   è¨Šæ¯é¡å‹                     UInt8 (å€¼: 3 = chat)
2       4 bytes  æ™‚é–“æˆ³                       UInt32 (Little Endian)
6       1 byte   è¨­å‚™åç¨±é•·åº¦                 UInt8
7       N bytes  è¨­å‚™åç¨±                     UTF-8å­—ç¬¦ä¸²
7+N     1 byte   è¨Šæ¯IDé•·åº¦                   UInt8
8+N     M bytes  è¨Šæ¯ID                       UTF-8å­—ç¬¦ä¸²
8+N+M   2 bytes  è¨Šæ¯å…§å®¹é•·åº¦                 UInt16 (Little Endian)
10+N+M  P bytes  è¨Šæ¯å…§å®¹                     UTF-8å­—ç¬¦ä¸²
```

### å®Œæ•´èŠå¤©è¨Šæ¯ç™¼é€æµç¨‹
1. **ChatViewModel.sendMessage()**:
   - å‰µå»º ChatMessage å°è±¡
   - ä½¿ç”¨ `encodeChatMessageToBinary()` ç·¨ç¢¼ç‚ºäºŒé€²åˆ¶
   - åŒ…è£æˆ MeshMessage(type: .chat, data: äºŒé€²åˆ¶æ•¸æ“š)
   - ä½¿ç”¨ `BinaryMessageEncoder.encode()` ç·¨ç¢¼æ•´å€‹ MeshMessage
   - çµæœ: é›™å±¤ç·¨ç¢¼æ ¼å¼

2. **ç™¼é€æ ¼å¼çµæ§‹**:
```
[MeshMessage é ­éƒ¨]
  - å”è­°ç‰ˆæœ¬ (1)
  - è¨Šæ¯é¡å‹ (3)
  - è¨Šæ¯IDé•·åº¦ + ID
  - æ•¸æ“šé•·åº¦
  - æ™‚é–“æˆ³
[ChatMessage äºŒé€²åˆ¶æ•¸æ“š]
  - æ™‚é–“æˆ³
  - è¨­å‚™åç¨±é•·åº¦ + åç¨±
  - è¨Šæ¯IDé•·åº¦ + ID
  - è¨Šæ¯å…§å®¹é•·åº¦ + å…§å®¹
```

## ğŸ” åŠ å¯†å±¤

### åŠ å¯†å‰æ ¼å¼
- æ¨™æº– MeshMessage äºŒé€²åˆ¶æ ¼å¼

### åŠ å¯†å¾Œæ ¼å¼
- ChaCha20-Poly1305 åŠ å¯†çš„å¯†æ–‡
- åŒ…å«èªè­‰æ¨™ç±¤ (16 bytes)
- æ¯å€‹å°ç­‰ç¯€é»ä½¿ç”¨ç¨ç«‹çš„æœƒè©±å¯†é‘°

### æ¥æ”¶è§£å¯†æµç¨‹
1. **ServiceContainer.routeChatMessage()**:
   - æª¢æŸ¥æ˜¯å¦æœ‰æœƒè©±å¯†é‘°
   - å¦‚æœæœ‰å¯†é‘°ä¸”éæ˜æ–‡ï¼ŒåŸ·è¡Œè§£å¯†
   - è§£å¯†å¤±æ•—å‰‡æ‹’çµ•è™•ç†
2. **ChatViewModel.decodeChatMessage()**:
   - ä½¿ç”¨ BinaryMessageDecoder.decode() è§£æå¤–å±¤
   - ä½¿ç”¨ decodeChatMessageFromBinary() è§£æå…§å±¤

## ğŸ¯ æ ¼å¼ä¸€è‡´æ€§é©—è­‰

### âœ… ç·¨ç¢¼å™¨èˆ‡è§£ç¢¼å™¨åŒ¹é…é»
1. **MeshMessage å±¤**:
   - ç·¨ç¢¼: ç‰ˆæœ¬(1) + é¡å‹(1) + IDé•·åº¦(1) + ID + æ•¸æ“šé•·åº¦(4) + æ™‚é–“æˆ³(4) + æ•¸æ“š
   - è§£ç¢¼: å®Œå…¨ç›¸åŒçš„é †åºå’Œæ ¼å¼

2. **ChatMessage å±¤**:
   - ç·¨ç¢¼: æ™‚é–“æˆ³(4) + è¨­å‚™åç¨±é•·åº¦(1) + è¨­å‚™åç¨± + IDé•·åº¦(1) + ID + è¨Šæ¯é•·åº¦(2) + è¨Šæ¯
   - è§£ç¢¼: å®Œå…¨ç›¸åŒçš„é †åºå’Œæ ¼å¼

3. **æ•¸æ“šé¡å‹ä¸€è‡´æ€§**:
   - æ‰€æœ‰æ•´æ•¸ä½¿ç”¨ Little Endian
   - å­—ç¬¦ä¸²ä½¿ç”¨ UTF-8 ç·¨ç¢¼
   - é•·åº¦æ¬„ä½ä½¿ç”¨é©ç•¶å¤§å° (UInt8/UInt16/UInt32)

## ğŸ“Š æ€§èƒ½å„ªåŒ–ç‰¹æ€§

1. **é åˆ†é…ç·©è¡å€**: 
   - `encodeOptimized()` ä½¿ç”¨å…±äº«ç·©è¡å€æ¸›å°‘è¨˜æ†¶é«”åˆ†é…

2. **æ‰¹é‡è™•ç†**:
   - `decodeBatch()` æ”¯æŒæ‰¹é‡è§£ç¢¼å¤šå€‹è¨Šæ¯

3. **å¿«é€Ÿé¡å‹æª¢æ¸¬**:
   - `detectMessageType()` åªè®€å–å‰2å­—ç¯€å¿«é€Ÿåˆ¤æ–·é¡å‹

4. **å®‰å…¨æª¢æŸ¥**:
   - æ‰€æœ‰é•·åº¦æ¬„ä½éƒ½æœ‰ä¸Šé™æª¢æŸ¥ (æœ€å¤§64å­—ç¯€)
   - é˜²æ­¢è¨˜æ†¶é«”è€—ç›¡æ”»æ“Š

## ğŸš¨ éŒ¯èª¤è™•ç†

### ç·¨ç¢¼éŒ¯èª¤
- `invalidMessageType`: ç„¡æ•ˆçš„è¨Šæ¯é¡å‹
- `dataTooLarge`: æ•¸æ“šè¶…éé™åˆ¶
- `stringEncodingFailed`: UTF-8ç·¨ç¢¼å¤±æ•—
- `invalidUUIDFormat`: UUIDæ ¼å¼ç„¡æ•ˆ

### è§£ç¢¼éŒ¯èª¤
- `invalidDataSize`: æ•¸æ“šå¤§å°ç„¡æ•ˆ
- `unsupportedVersion`: å”è­°ç‰ˆæœ¬ä¸æ”¯æŒ
- `invalidMessageType`: è¨Šæ¯é¡å‹ç„¡æ•ˆ
- `stringDecodingFailed`: UTF-8è§£ç¢¼å¤±æ•—
- `corruptedData`: æ•¸æ“šæå£

## ğŸ” è¨ºæ–·å·¥å…·

`BinaryMessageDecoder.analyzeFailedData()` æä¾›è©³ç´°çš„éŒ¯èª¤åˆ†æ:
- é¡¯ç¤ºæ•¸æ“šå‰20å­—ç¯€çš„åå…­é€²åˆ¶
- åˆ†æå”è­°ç‰ˆæœ¬å’Œè¨Šæ¯é¡å‹
- æä¾›è§£ç¢¼å»ºè­°

## ç¸½çµ

äºŒé€²åˆ¶ç·¨ç¢¼å™¨/è§£ç¢¼å™¨å¯¦ç¾äº†å®Œæ•´çš„æ ¼å¼ä¸€è‡´æ€§ï¼š
- âœ… çµ±ä¸€çš„å”è­°ç‰ˆæœ¬å’Œè¨Šæ¯é¡å‹ç³»çµ±
- âœ… ä¸€è‡´çš„æ•¸æ“šç·¨ç¢¼æ ¼å¼ (Little Endian)
- âœ… å®Œæ•´çš„éŒ¯èª¤æª¢æŸ¥å’Œå®‰å…¨é©—è­‰
- âœ… æ”¯æŒ30è¬ç”¨æˆ¶è¦æ¨¡çš„æ€§èƒ½å„ªåŒ–
- âœ… èŠå¤©è¨Šæ¯ä½¿ç”¨é›™å±¤ç·¨ç¢¼ç¢ºä¿æ ¼å¼çµ±ä¸€