# JustifiedText 組件使用指南 v2.3

## 🆕 最新更新（v2.3）

### ✅ 文字溢出保護功能
- **問題解決**：防止文字超出螢幕被切掉
- **智能換行**：在標點符號控制和溢出保護間取得平衡
- **保護機制**：
  - 溢出檢測：超過容器寬度15%時強制換行
  - 間距保護：當內容超出容器時使用最小間距
  - 優先保證：文字完全可見 > 標點符號規則

### ✅ 標點符號行首問題完全修復（v2.2）
- **問題解決**：標點符號不再會出現在行首
- **檢測方法**：使用字符寬度檢測來精確識別標點符號
- **處理範圍**：
  - 英文標點符號（寬度 ≤ 8px）：不允許在行首
  - 中文標點符號（寬度 8-16px）：不允許在行首
  - 正常字符（寬度 > 16px）：允許在行首

**測試通過的標點符號：**
- 中文標點：。！？，；：」』）】
- 英文標點：. ! ? , ; : ) ] }
- 配對符號：「」『』（）【】等

詳細技術說明請參考：`OVERFLOW_PROTECTION_TEST.md`

---

## 概述

`JustifiedTextComponents.swift` 提供了一個高效的 SwiftUI 文字左右對齊解決方案，特別適合處理繁體中文和中英文混合內容，並且支援**智能標點符號處理**和**條款編號智能間距**功能。

## 主要特點

### ✅ 智能文字分解
- **中文字符**：按字分解，智能控制換行位置
- **英文單詞**：按詞分解，保持單詞完整性
- **標點符號**：智能處理，避免行首出現標點符號
- **CJK 支援**：完整支援中文、日文、韓文字符集

### ✅ 智能標點符號處理 🆕
- **行首控制**：標點符號不會出現在行首
- **配對符號**：「」『』（）【】等配對符號智能處理
- **中文標點**：。！？，；：、等符號遵循中文排版規範
- **英文標點**：. ! ? , ; : 等符號智能換行

### ✅ 條款編號智能間距 🆕
- **自動間距**：條款編號之間自動加上兩格空白
- **不強制換行**：條款編號不會強制換行，保持自然排版
- **多種格式**：支援 1. 1.1 1.2.3 (1) a) i) A. 等格式
- **智能識別**：自動識別各種編號格式

### ✅ 先進佈局算法
- 使用 SwiftUI Layout Protocol 實現
- 智能空間分配演算法
- 快取機制優化效能
- 彈性間距調整

### ✅ 易於使用
- 簡單的 API 設計
- 與現有 SwiftUI 代碼完全相容
- 支援鏈式修飾符

## 基本用法

### 1. 簡單使用
```swift
JustifiedText(
    text: "這是一段需要左右對齊的文字內容。",
    font: .system(size: 16),
    lineSpacing: 4
)
```

### 2. 條款編號文字
```swift
JustifiedText(
    text: """
    1. 第一條款內容說明。1.1 子條款詳細規則。1.2 另一個子條款。2. 第二條款內容。
    """,
    font: .system(size: 15),
    lineSpacing: 4
)
```

### 3. 智能標點符號處理
```swift
JustifiedText(
    text: "測試標點符號：句號。感嘆號！問號？這些符號不會出現在行首。「引號內容」也會正確處理。",
    font: .system(size: 15),
    lineSpacing: 4
)
```

### 4. 法律文件格式
```swift
JustifiedText(
    text: """
    第一章 總則 1. 為規範本應用程式的使用，保護用戶權益，特制定本條款。1.1 本條款適用於所有使用本應用程式的用戶。1.2 用戶使用本應用程式即表示同意遵守本條款。
    """,
    font: .system(size: 15),
    lineSpacing: 4
)
```

## 支援的編號格式

| 格式類型 | 範例 | 智能間距 | 不強制換行 |
|---------|------|---------|----------|
| 數字編號 | `1.` `2.` `3.` | ✅ | ✅ |
| 子編號 | `1.1` `1.2` `2.1` | ✅ | ✅ |
| 多層編號 | `1.1.1` `1.2.3` | ✅ | ✅ |
| 括號編號 | `(1)` `(2)` `(3)` | ✅ | ✅ |
| 小寫字母 | `a)` `b)` `c)` | ✅ | ✅ |
| 大寫字母 | `A.` `B.` `C.` | ✅ | ✅ |
| 羅馬數字 | `i)` `ii)` `iii)` | ✅ | ✅ |

## 智能標點符號規則

### 不能在行首的標點符號
| 類型 | 符號 |
|------|------|
| 英文標點 | `. ! ? ; : , ) ] } >` |
| 中文標點 | `。！？；：，、）】〕｝》〉」』` |

### 智能配對符號處理
| 開始符號 | 結束符號 | 處理方式 |
|---------|---------|---------|
| `「` | `」` | 開始符號後不換行，結束符號前不換行 |
| `『` | `』` | 開始符號後不換行，結束符號前不換行 |
| `（` | `）` | 開始符號後不換行，結束符號前不換行 |
| `【` | `】` | 開始符號後不換行，結束符號前不換行 |

## 自動間距功能

### 條款編號間距
- **觸發條件**：標點符號（. ! ? 。！？）後接數字編號
- **間距大小**：兩格空白（`  `）
- **適用範圍**：`1.` `1.1` `2.` `(1)` 等格式

### 範例對比
```
// 輸入文字
"1. 第一條款。1.1 子條款。2. 第二條款。"

// 處理後效果
"1. 第一條款。  1.1 子條款。  2. 第二條款。"
```

## 在專案中的應用

### 隱私權政策和服務條款

已成功應用於：
- `PrivacyPolicyView.swift`
- `TermsOfServiceView.swift`

範例：
```swift
PolicySection(
    title: "資料收集與用途",
    content: """
    1. 個人資料收集：本公司會收集用戶的基本資料。1.1 收集範圍包括姓名、聯絡方式等。1.2 收集目的為提供更好的服務。2. 資料用途說明：收集的資料僅用於服務提供。
    """
)

struct PolicySection: View {
    let title: String
    let content: String
    
    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            Text(title)
                .font(.system(size: 15))
                .fontWeight(.semibold)
            
            JustifiedText(
                text: content,
                font: .system(size: 15),
                lineSpacing: 4
            )
            .foregroundColor(.secondary)
        }
    }
}
```

## 技術實現

### 核心組件

1. **JustifiedText**: 主要對外接口
2. **JustifiedLayout**: Layout Protocol 實現
3. **TextSplitter**: 智能文字分解器
4. **JustifiedTextSegment**: 文字片段模型

### 新增功能

1. **splitTextWithSmartRules()**: 主要分解方法，應用智能規則
2. **preprocessNumberingSpacing()**: 條款編號間距預處理
3. **isNumberingText()**: 條款編號格式識別
4. **canBreakAfterChinese()**: 中文字符換行控制
5. **shouldStartLineWithPunctuation()**: 標點符號行首控制
6. **optimizeSegments()**: 片段優化處理

### 演算法特點

- **預處理機制**: 在分解前先處理條款編號間距
- **智能識別**: 使用正則表達式識別各種編號格式
- **上下文感知**: 考慮前後字符進行智能換行決策
- **效能優化**: 快取機制和片段合併優化

## 最佳實踐

### ✅ 建議做法

1. **適合的內容類型**：
   - 法律文件（條款、政策等）
   - 使用說明和操作指南
   - 規則清單和項目列表
   - 正式文件和合約

2. **編號格式建議**：
   - 使用標準編號格式（1. 1.1 1.2）
   - 保持編號格式一致性
   - 避免過於複雜的編號系統

3. **標點符號使用**：
   - 遵循中文排版規範
   - 注意配對符號的正確使用
   - 避免不必要的標點符號

### ❌ 避免使用於

1. **不規則編號**: 自定義或不標準的編號格式
2. **短文字**: 單行或兩行的簡短內容
3. **互動元素**: 按鈕文字或表單標籤

## 範例展示

### 完整服務條款範例
```swift
JustifiedText(
    text: """
    第一章 服務總則 1. 服務說明：本應用提供即時通訊服務。1.1 基本功能包括文字訊息傳送、語音通話等。1.2 進階功能包含端對端加密、多裝置同步等。2. 用戶責任：用戶應遵守使用規範。2.1 帳號管理：保護密碼安全、及時更新資料等。2.2 內容規範：不發送違法內容、尊重智慧財產權等。
    """,
    font: .system(size: 15),
    lineSpacing: 4
)
```

### 標點符號處理範例
```swift
JustifiedText(
    text: """
    重要提醒：使用本服務前，請仔細閱讀相關條款。如有疑問，請聯繫客服？我們將竭誠為您服務！「用戶隱私」是我們最重視的議題，《隱私權政策》詳載相關說明。
    """,
    font: .system(size: 15),
    lineSpacing: 4
)
```

## 相容性

- **iOS 版本**: 16.0+
- **SwiftUI 版本**: 支援所有現代版本
- **裝置支援**: iPhone、iPad 通用
- **向下相容**: 完全相容原有 JustifiedText 功能

## 效能考量

- 使用了快取機制，避免重複計算
- Layout Protocol 確保高效能渲染
- 正則表達式優化，減少處理時間
- 適合中等長度的文字內容（2000 字以內）
- 預處理機制提升整體效能

## 疑難排解

### 常見問題

1. **編號間距異常**: 檢查編號格式是否符合支援的模式
2. **標點符號出現在行首**: 確認是否有不支援的標點符號
3. **佈局異常**: 檢查父容器的寬度設置
4. **效能問題**: 避免在 List 的每個 cell 中使用過長文字

### 除錯技巧

```swift
// 測試特定功能
let testText = """
1. 測試條款。1.1 子條款內容。標點符號測試：句號。感嘆號！問號？
"""

// 使用預覽功能查看效果
#if DEBUG
struct MyView_Previews: PreviewProvider {
    static var previews: some View {
        JustifiedText(text: testText)
            .padding()
    }
}
#endif
```

### 功能驗證

```swift
// 驗證編號間距
let numberingTest = "1. 內容。1.1 子內容。2. 下一條。"

// 驗證標點符號處理
let punctuationTest = "測試：句號。感嘆號！「引號」內容。"

// 在測試檔案中查看實際效果
JustifiedTextTestView()
```

## 版本歷史

- **v1.0**: 初始實現，支援基本左右對齊
- **v1.1**: 新增 CJK 字符支援和效能優化
- **v1.2**: 加入智能標點符號處理
- **v2.0**: 🆕 新增條款編號和間隔號自動換行功能
- **v2.1**: 🆕 改進智能標點符號處理和條款編號智能間距（不強制換行）

## 最新更新（v2.3）

### 文字溢出保護功能
✅ **已實現**：防止文字超出螢幕被切掉

**改進內容：**
- 溢出檢測：超過容器寬度15%時強制換行
- 間距保護：當內容超出容器時使用最小間距
- 優先保證：文字完全可見 > 標點符號規則

### 標點符號行首問題修復
✅ **已修復**：標點符號不再會出現在行首

**改進內容：**
- 使用字符寬度檢測來識別標點符號
- 英文標點符號（寬度 ≤ 8px）：不允許在行首
- 中文標點符號（寬度 8-16px）：不允許在行首
- 正常字符（寬度 > 16px）：允許在行首

**測試通過的標點符號：**
- 中文標點：。！？，；：」』）】
- 英文標點：. ! ? , ; : ) ] }
- 配對符號：「」『』（）【】等

---

如需更多幫助或遇到問題，請查看 `JustifiedTextTest.swift` 中的完整功能展示範例。
