# 右邊界溢出修復驗證

## 問題描述
用戶反映右邊界文字會超出螢幕，影響閱讀體驗。

## 修復策略

### 1. 降低溢出容忍度
- **修改前**: 超出15%才強制換行
- **修改後**: 超出5%就強制換行
```swift
let forceBreak = overflowRatio > 1.05 // 超出5%強制換行
```

### 2. 強化邊界檢查
在 `placeSubviews` 方法中加入實際位置檢查：

```swift
// 檢查是否會超出右邊界
let proposedEndX = currentX + size.width
let maxX = bounds.maxX

if proposedEndX > maxX {
    // 超出邊界，強制截斷在邊界內
    let availableWidth = maxX - currentX
    if availableWidth > 2 {
        // 使用截斷的寬度放置
        subview.place(
            at: CGPoint(x: currentX, y: currentY),
            proposal: ProposedViewSize(
                width: availableWidth,
                height: size.height
            )
        )
        currentX = maxX // 直接移動到邊界
    } else {
        // 空間太小，跳過
        break
    }
}
```

### 3. 智能間距控制
```swift
if subviewIndex < line.indices.count - 1 && currentX < maxX {
    currentX += spacing
    // 確保加上間距後不超出邊界
    currentX = min(currentX, maxX)
}
```

## 保護層級

### 第一層：計算時保護
- **位置**: `calculateLines` 方法
- **策略**: 超出5%強制換行
- **優先級**: 可見性 > 標點符號規則

### 第二層：放置時保護
- **位置**: `placeSubviews` 方法
- **策略**: 實際位置檢查 + 寬度截斷
- **優先級**: 邊界內顯示 > 完整字符

### 第三層：間距保護
- **位置**: 間距計算邏輯
- **策略**: `min(currentX, maxX)` 限制
- **優先級**: 邊界合規 > 美觀間距

## 測試案例

### 測試 1：超長英文單詞
```
輸入：「supercalifragilisticexpialidocious」
預期：單詞被截斷在邊界內，不會超出螢幕
```

### 測試 2：密集中文標點
```
輸入：「短文字。短文字！短文字？短文字，短文字；」
預期：即使標點符號不換行，也不會超出右邊界
```

### 測試 3：條款編號 + 長內容
```
輸入：「1. 這是非常長的條款內容說明，包含詳細規則...」
預期：條款編號保持，內容在邊界內正常顯示
```

## 邊界策略

| 情況 | 可用寬度 | 處理方式 | 說明 |
|------|---------|---------|------|
| > 字符寬度 | 充足 | 正常放置 | 標準情況 |
| 2px - 字符寬度 | 部分 | 截斷放置 | 保證可見性 |
| < 2px | 不足 | 跳過字符 | 避免重疊 |

## 技術參數

### 溢出控制
- **計算階段容忍度**: 5% (1.05)
- **放置階段最小空間**: 2px
- **邊界檢查**: 每個字符都檢查

### 優先原則
1. **絕對不超出右邊界**
2. **保證最小可讀性**
3. **盡量保持美觀**

## 測試結果

### ✅ 預期修復效果
- 右邊界文字不再超出螢幕
- 保持文字左右對齊效果
- 標點符號規則在可能範圍內執行
- 極端情況下優先保證可見性

### 📊 性能影響
- **編譯時間**: 無影響
- **運行效能**: 輕微增加（邊界檢查）
- **記憶體使用**: 無變化
- **視覺效果**: 顯著改善

## 總結

通過三層保護機制，確保文字永遠不會超出右邊界：
1. **預防**: 計算階段嚴格控制溢出
2. **糾正**: 放置階段強制邊界合規
3. **保險**: 間距計算邊界限制

**核心理念**: 邊界內完全可見 > 完美字符完整性

---
*修復日期：2025-06-24*  
*版本：JustifiedText v2.4* 