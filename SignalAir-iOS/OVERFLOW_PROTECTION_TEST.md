# 文字溢出保護功能測試

## 問題描述
用戶反映在防止標點符號換行時，文字會超出螢幕被切掉，影響閱讀體驗。

## 解決方案

### 1. 溢出保護機制
在 `calculateLines` 方法中加入了智能溢出保護：

```swift
// 檢查溢出程度：如果超出太多，強制換行
let overflowRatio = proposedWidth / maxWidth
let forceBreak = overflowRatio > 1.3 // 超出30%強制換行

if canStartNewLine || forceBreak {
    // 執行換行，即使字符不能在行首
}
```

### 2. 間距保護機制
在 `placeSubviews` 方法中改進了間距計算：

```swift
// 改進間距計算：防止負間距或過度擁擠
let spacing: CGFloat
if isLastLine {
    spacing = wordSpacing
} else if extraSpace < 0 {
    // 內容超出容器寬度，使用最小間距
    spacing = max(1, wordSpacing * 0.5)
} else {
    // 正常情況下的左右對齊
    spacing = max(wordSpacing, extraSpace / CGFloat(spaceCount))
}
```

### 3. 保護邏輯

#### 第一層保護：標點符號檢查
- 檢查下一個字符是否可以在行首
- 標點符號不允許在行首

#### 第二層保護：溢出檢查
- 計算溢出比例：`proposedWidth / maxWidth`
- 當溢出超過 30% 時強制換行
- 即使是標點符號也會被強制換行

#### 第三層保護：間距調整
- 當內容寬度超出容器時，使用最小間距
- 防止負間距導致文字重疊
- 保持最低可讀性

## 測試案例

### 測試 1：極長單詞
```
輸入：「這是一個包含非常非常非常長的英文單詞supercalifragilisticexpialidocious的測試。」
預期：長單詞會被強制換行，不會超出螢幕
```

### 測試 2：密集標點符號
```
輸入：「短句。短句！短句？短句，短句；短句：」
預期：即使標點符號密集，也不會過度溢出
```

### 測試 3：條款編號溢出
```
輸入：「1. 這是一個非常長的條款內容說明，包含詳細的規則和限制條件。1.1 子條款也很長。」
預期：條款編號不會導致過度溢出
```

## 技術參數

### 溢出閾值
- **允許溢出**：15% 以內
- **強制換行**：超過 15%
- **最小間距**：0.5 * wordSpacing

### 間距策略
| 情況 | 間距計算 | 說明 |
|------|---------|------|
| 正常行 | `max(wordSpacing, extraSpace / spaceCount)` | 左右對齊 |
| 最後一行 | `wordSpacing` | 固定間距 |
| 溢出行 | `max(1, wordSpacing * 0.5)` | 最小可讀間距 |

## 效果驗證

### ✅ 解決的問題
1. **文字不再超出螢幕**：溢出保護機制生效
2. **保持標點符號規則**：在不過度溢出的前提下避免標點符號在行首
3. **改善可讀性**：最小間距保證文字不會重疊

### ⚖️ 平衡取捨
1. **標點符號規則 vs 溢出控制**：當溢出過多時，允許標點符號在行首
2. **左右對齊 vs 可讀性**：溢出時使用最小間距而非負間距
3. **美觀 vs 功能性**：優先保證文字完全可見

## 使用建議

### 適合的場景
- 法律文件（條款較長）
- 使用說明（內容豐富）
- 長篇文字內容

### 注意事項
- 極短的容器寬度可能仍會有輕微溢出
- 英文長單詞可能會觸發強制換行
- 密集標點符號會優先保持在同一行

## 更新日期
2025-06-24：完成文字溢出保護功能 