# 🏗️ SignalAir 架構圖與信任驗證流程

## 📊 系統架構總覽

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              SignalAir iOS 架構                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│  🎨 UI 層 (SwiftUI)                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  ChatView   │  │ SignalView  │  │ GameView    │  │ SettingsView│            │
│  │  聊天介面   │  │ 信號介面    │  │ 遊戲介面    │  │ 設定介面    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
├─────────────────────────────────────────────────────────────────────────────────┤
│  📦 服務容器層 (ServiceContainer)                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        🏭 ServiceContainer                                  │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │ │
│  │  │NetworkService│  │SecurityService│ │ MeshManager │  │LanguageService│      │ │
│  │  │  網路服務    │  │  安全服務    │  │ 網格管理器  │  │ 語言服務    │       │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────────┤
│  🔐 身份驗證與信任管理層                                                        │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  🆔 身份管理模組                                                          │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │  │
│  │  │TemporaryID  │  │DeviceFingerprint│ │NicknameService│ │SecurityService│  │  │
│  │  │   Manager   │  │   Manager   │  │   暱稱服務  │  │   安全服務  │     │  │
│  │  │台灣小吃ID系統│  │  設備指紋   │  │   動態暱稱  │  │  密鑰管理   │     │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  🛡️ 信任與安全模組                                                        │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │  │
│  │  │TrustScore   │  │BehaviorAnalysis│ │ContentValidator│ │SecurityLog  │    │  │
│  │  │  Manager    │  │   System    │  │   内容验证  │  │   Manager   │     │  │
│  │  │ 信任評分系統│  │  行為分析   │  │   惡意檢測  │  │  安全日誌   │     │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  🌐 網路通信層                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  📡 P2P 網路管理                                                           │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │  │
│  │  │ConnectionRate│  │   MeshManager│  │TopologyManager│ │AutoReconnect│     │  │
│  │  │  Manager    │  │  網格管理器 │  │  拓撲管理   │  │  Manager    │     │  │
│  │  │ 連接速率控制│  │  路由轉發   │  │  網路發現   │  │  自動重連   │     │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  🔒 安全防護層                                                            │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │  │
│  │  │DataTransfer │  │UserAccess   │  │SecurityHealth│ │LocalBlacklist│     │  │
│  │  │  Monitor    │  │  Manager    │  │  Monitor    │  │  Manager    │     │  │
│  │  │ 數據傳輸監控│  │ 用戶存取管理│  │ 系統健康監控│  │ 本地黑名單  │     │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  💾 數據持久化層                                                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ UserDefaults│  │  CoreData   │  │  Keychain   │  │ File System │            │
│  │  偏好設定   │  │  數據庫     │  │  安全存儲   │  │  文件系統   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🔐 身份驗證機制詳細流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            🆔 身份驗證流程圖                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  📱 設備啟動                                                                    │
│       ↓                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🍜 TemporaryIDManager                                                  │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │   │
│  │  │  生成台灣小吃ID  │  │  每日午夜更新   │  │  隱私保護設計   │        │   │
│  │  │  "牛肉麵-A3B7"   │  │  防止長期追蹤   │  │  50種小吃輪換   │        │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       ↓                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🔑 DeviceFingerprintManager                                           │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │   │
│  │  │  設備指紋生成   │  │  硬體特徵收集   │  │  信任評分整合   │        │   │
│  │  │  UUID + 系統資訊 │  │  型號/版本/容量 │  │  TrustScoreManager│       │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       ↓                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🔐 SecurityService - 密鑰管理                                          │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │   │
│  │  │  Curve25519     │  │  ECDH 密鑰交換  │  │  會話密鑰管理   │        │   │
│  │  │  私鑰生成       │  │  前向安全性     │  │  定期輪轉       │        │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🤝 節點間通訊流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        🌐 P2P 節點通訊流程                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  📱 節點A                                  📱 節點B                            │
│       ↓                                         ↓                              │
│  ┌─────────────────┐                       ┌─────────────────┐                │
│  │  1. 設備發現    │  ←──────────────────→  │  1. 設備發現    │                │
│  │  MultipeerConnectivity                  │  附近設備廣播   │                │
│  └─────────────────┘                       └─────────────────┘                │
│       ↓                                         ↓                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🔍 2. 連接建立與安全檢查                                                 │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │BehaviorAnalysis │  │ConnectionRate   │  │TrustScore       │          │   │
│  │  │威脅等級評估     │  │速率限制檢查     │  │信任評分檢查     │          │   │
│  │  │safe/suspicious  │  │防洪水攻擊       │  │黑名單檢查       │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       ↓                                         ↓                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🔐 3. 密鑰交換流程                                                       │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │  發送公鑰       │  │  ECDH 協商      │  │  會話密鑰生成   │          │   │
│  │  │  + 台灣小吃ID   │  │  共享密鑰計算   │  │  雙向認證       │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       ↓                                         ↓                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  📡 4. 消息傳輸與驗證                                                     │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │  二進制編碼     │  │  AES-GCM 加密   │  │  HMAC 完整性    │          │   │
│  │  │  高效協議       │  │  認證加密       │  │  防篡改驗證     │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       ↓                                         ↓                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🛡️ 5. 內容驗證與信任更新                                                │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │ContentValidator │  │LocalBlacklist   │  │SecurityLog      │          │   │
│  │  │惡意內容檢測     │  │黑名單過濾       │  │事件記錄         │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## ⚡ 關鍵決策點分析

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            🎯 決策點流程圖                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  📥 消息/連接請求                                                               │
│       ↓                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🚨 決策點 1: 連接安全檢查                                                │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │BehaviorAnalysis │  │  檢查結果：     │  │    決策：       │          │   │
│  │  │.analyzeConnection│  │  • safe: 通過   │  │  • 允許連接     │          │   │
│  │  │威脅等級評估     │  │  • suspicious:  │  │  • 延遲處理     │          │   │
│  │  │⏱️ 延遲: 10-50ms │  │    觀察名單     │  │  • 直接拒絕     │          │   │
│  │  │                 │  │  • dangerous:   │  │  • 記錄事件     │          │   │
│  │  │                 │  │    立即拒絕     │  │                 │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       ↓                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🚨 決策點 2: 速率限制檢查                                                │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │ConnectionRate   │  │  檢查內容：     │  │    決策：       │          │   │
│  │  │Manager          │  │  • 每秒消息數   │  │  • 正常處理     │          │   │
│  │  │多層限制機制     │  │  • 每分鐘限制   │  │  • 延遲處理     │          │   │
│  │  │⏱️ 延遲: 1-5ms   │  │  • 突發限制     │  │  • 臨時封禁     │          │   │
│  │  │                 │  │  • 模式檢測     │  │  • 記錄統計     │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       ↓                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🚨 決策點 3: 信任評分檢查                                                │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │TrustScore       │  │  檢查內容：     │  │    決策：       │          │   │
│  │  │Manager          │  │  • 信任評分     │  │  • 正常處理     │          │   │
│  │  │動態評分系統     │  │  • 黑名單狀態   │  │  • 降低優先級   │          │   │
│  │  │⏱️ 延遲: 5-15ms  │  │  • 觀察名單     │  │  • 拒絕處理     │          │   │
│  │  │                 │  │  • 歷史行為     │  │  • 更新評分     │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       ↓                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🚨 決策點 4: 內容驗證                                                    │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │ContentValidator │  │  檢查內容：     │  │    決策：       │          │   │
│  │  │內容安全檢查     │  │  • 惡意內容     │  │  • 通過處理     │          │   │
│  │  │模式匹配系統     │  │  • 垃圾信息     │  │  • 內容過濾     │          │   │
│  │  │⏱️ 延遲: 5-20ms  │  │  • 異常模式     │  │  • 阻止傳播     │          │   │
│  │  │                 │  │  • 關鍵字檢測   │  │  • 懲罰評分     │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       ↓                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  ✅ 最終決策：消息處理                                                    │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │  正常處理       │  │  延遲處理       │  │  拒絕處理       │          │   │
│  │  │  • 解密消息     │  │  • 延遲隊列     │  │  • 記錄事件     │          │   │
│  │  │  • 路由轉發     │  │  • 降低優先級   │  │  • 更新統計     │          │   │
│  │  │  • 更新信任     │  │  • 監控狀態     │  │  • 觸發警報     │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  📊 總決策延遲: 20-90ms (視系統負載而定)                                       │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🎯 信任驗證系統詳細架構

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        🛡️ 信任驗證系統架構                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🧠 TrustScoreManager (信任評分管理器)                                   │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │  動態評分系統   │  │  異步處理系統   │  │  批量處理系統   │          │   │
│  │  │  • 初始分數50   │  │  • 異步更新     │  │  • 批量計算     │          │   │
│  │  │  • 範圍0-100    │  │  • 防阻塞設計   │  │  • 性能優化     │          │   │
│  │  │  • 實時調整     │  │  • 後台隊列     │  │  • 內存管理     │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │  評分觸發事件   │  │  評分計算規則   │  │  行為懲罰機制   │          │   │
│  │  │  • 成功通信+2   │  │  • 線性計算     │  │  • 異常行為-5   │          │   │
│  │  │  • 協助轉發+1   │  │  • 權重調整     │  │  • 惡意內容-10  │          │   │
│  │  │  • 正常連接+1   │  │  • 時間衰減     │  │  • 攻擊行為-20  │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       ↓                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🔍 BehaviorAnalysisSystem (行為分析系統)                                │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │  連接模式分析   │  │  內容模式分析   │  │  時間模式分析   │          │   │
│  │  │  • 連接頻率     │  │  • 重複內容     │  │  • 活動時間     │          │   │
│  │  │  • 連接時長     │  │  • 垃圾信息     │  │  • 規律性檢測   │          │   │
│  │  │  • 異常斷線     │  │  • 異常模式     │  │  • 異常活動     │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │   │
│  │  │  威脅等級評估系統                                                   │ │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │ │   │
│  │  │  │    Safe      │  │ Suspicious  │  │ Dangerous   │                │ │   │
│  │  │  │   安全等級   │  │  可疑等級   │  │  危險等級   │                │ │   │
│  │  │  │  正常通過    │  │  加強監控   │  │  立即阻止   │                │ │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘                │ │   │
│  │  └─────────────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       ↓                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  📋 LocalBlacklistManager (本地黑名單管理)                               │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │  持久化存儲     │  │  快速查詢       │  │  統計分析       │          │   │
│  │  │  • JSON 編碼    │  │  • 內存索引     │  │  • 封禁統計     │          │   │
│  │  │  • UserDefaults │  │  • O(1)查詢     │  │  • 趨勢分析     │          │   │
│  │  │  • 自動同步     │  │  • 多重檢查     │  │  • 清理策略     │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│       ↓                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  🔍 ContentValidator (內容驗證器)                                         │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │  關鍵字檢測     │  │  模式匹配       │  │  機器學習       │          │   │
│  │  │  • 不當內容     │  │  • 垃圾信息     │  │  • 異常檢測     │          │   │
│  │  │  • 敏感詞彙     │  │  • 重複模式     │  │  • 行為預測     │          │   │
│  │  │  • 多語言支持   │  │  • 正則表達式   │  │  • 自動學習     │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```