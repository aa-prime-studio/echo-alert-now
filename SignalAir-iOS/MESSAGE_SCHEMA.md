# SignalAir 訊息格式說明表 (Message Schema Documentation)

## 📋 目錄
- [基本規範](#基本規範)
- [通用訊息格式](#通用訊息格式)
- [訊息類型清單](#訊息類型清單)
- [詳細格式說明](#詳細格式說明)
- [範例說明](#範例說明)
- [錯誤處理](#錯誤處理)

---

## 🔧 基本規範

### 協議版本
- **當前版本**: `1`
- **版本欄位**: 1 byte (UInt8)
- **位置**: 訊息開頭第一個字節

### 編碼規範
- **字節序**: Little Endian
- **字符串編碼**: UTF-8
- **最大訊息大小**: 64KB (65536 bytes)
- **最小頭部大小**: 12 bytes

### 數據類型
- `UInt8`: 1 byte 無符號整數
- `UInt16`: 2 bytes 無符號整數 (Little Endian)
- `UInt32`: 4 bytes 無符號整數 (Little Endian)
- `String`: UTF-8 編碼，前綴長度欄位
- `Data`: 原始字節數據，前綴長度欄位

---

## 📦 通用訊息格式

### 標準 MeshMessage 格式
```
┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│ 協議版本    │ 訊息類型    │ ID 長度     │ 訊息 ID     │ 數據長度    │ 時間戳      │ 訊息數據    │
│ (1 byte)    │ (1 byte)    │ (1 byte)    │ (變長)      │ (4 bytes)   │ (4 bytes)   │ (變長)      │
│ Protocol    │ Message     │ ID Length   │ Message ID  │ Data Length │ Timestamp   │ Message     │
│ Version     │ Type        │             │             │ (LE)        │ (Unix LE)   │ Data        │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
```

### 欄位說明
| 欄位 | 大小 | 類型 | 說明 |
|------|------|------|------|
| 協議版本 | 1 byte | UInt8 | 固定值: `0x01` |
| 訊息類型 | 1 byte | UInt8 | 見 [訊息類型清單](#訊息類型清單) |
| ID 長度 | 1 byte | UInt8 | 訊息 ID 的字節長度 (通常 36 for UUID) |
| 訊息 ID | 變長 | String | UUID 字符串，用於追蹤和去重 |
| 數據長度 | 4 bytes | UInt32 | 訊息數據的字節長度 (Little Endian) |
| 時間戳 | 4 bytes | UInt32 | Unix 時間戳 (Little Endian) |
| 訊息數據 | 變長 | Data | 實際的訊息內容，格式依訊息類型而定 |

---

## 🔖 訊息類型清單

| 類型碼 | 十六進制 | 名稱 | 說明 |
|--------|----------|------|------|
| 1 | 0x01 | `signal` | 緊急信號訊息 |
| 2 | 0x02 | `emergency` | 緊急求救訊息 |
| 3 | 0x03 | `chat` | 聊天訊息 |
| 4 | 0x04 | `system` | 系統訊息 |
| 5 | 0x05 | `keyExchange` | 密鑰交換請求 |
| 6 | 0x06 | `game` | 遊戲訊息 |
| 7 | 0x07 | `topology` | 網路拓撲訊息 |
| 8 | 0x08 | `keyExchangeResponse` | 密鑰交換響應 |
| 9 | 0x09 | `heartbeat` | 心跳訊息 |
| 10 | 0x0A | `routingUpdate` | 路由更新訊息 |

---

## 📄 詳細格式說明

### 1. 緊急信號訊息 (signal - 0x01)

**用途**: 災難救援、緊急求助信號廣播

**訊息數據格式**:
```
┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│ 信號類型    │ 發送者長度  │ 發送者 ID   │ 位置長度    │ 位置信息    │ 附加數據    │
│ (1 byte)    │ (1 byte)    │ (變長)      │ (1 byte)    │ (變長)      │ (變長)      │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
```

**信號類型清單**:
| 代碼 | 名稱 | 說明 |
|------|------|------|
| 0x01 | `medical` | 醫療救助 |
| 0x02 | `fire` | 火災救援 |
| 0x03 | `supplies` | 物資需求 |
| 0x04 | `danger` | 危險警告 |
| 0x05 | `safe` | 安全確認 |

### 2. 聊天訊息 (chat - 0x03)

**用途**: 用戶間的文字通信

**訊息數據格式**:
```
┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│ 發送者長度  │ 發送者名稱  │ 設備ID長度  │ 設備 ID     │ 訊息長度    │ 訊息內容    │
│ (1 byte)    │ (變長)      │ (1 byte)    │ (變長)      │ (2 bytes)   │ (變長)      │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
```

### 3. 密鑰交換 (keyExchange - 0x05)

**用途**: 建立端到端加密通道

**訊息數據格式**:
```
┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│ 重試次數    │ 發送者長度  │ 發送者 ID   │ 公鑰長度    │ 公鑰數據    │
│ (1 byte)    │ (1 byte)    │ (變長)      │ (2 bytes)   │ (變長)      │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
```

### 4. 密鑰交換響應 (keyExchangeResponse - 0x08)

**用途**: 密鑰交換的響應訊息

**訊息數據格式**:
```
┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│ 狀態代碼    │ 發送者長度  │ 發送者 ID   │ 公鑰長度    │ 公鑰數據    │ 錯誤長度    │ 錯誤訊息    │
│ (1 byte)    │ (1 byte)    │ (變長)      │ (2 bytes)   │ (變長)      │ (1 byte)    │ (變長)      │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
```

**狀態代碼**:
| 代碼 | 名稱 | 說明 |
|------|------|------|
| 0x00 | `success` | 成功 |
| 0x01 | `failure` | 失敗 |
| 0x02 | `retry` | 需要重試 |

### 5. 遊戲訊息 (game - 0x06)

**用途**: 賓果遊戲相關操作

**訊息數據格式**:
```
┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│ 遊戲子類型  │ 發送者長度  │ 發送者名稱  │ 房間 ID     │ 玩家 ID     │ 遊戲數據    │
│ (1 byte)    │ (1 byte)    │ (變長)      │ (4 bytes)   │ (36 bytes)  │ (變長)      │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
```

**遊戲子類型清單**:
| 代碼 | 名稱 | 說明 |
|------|------|------|
| 0x01 | `join_request` | 加入房間請求 |
| 0x02 | `join_response` | 加入房間響應 |
| 0x03 | `player_joined` | 玩家已加入 |
| 0x04 | `player_left` | 玩家離開 |
| 0x05 | `game_start` | 遊戲開始 |
| 0x06 | `number_drawn` | 抽取號碼 |
| 0x07 | `bingo_claim` | 賓果聲明 |
| 0x08 | `game_end` | 遊戲結束 |

### 6. 網路拓撲 (topology - 0x07)

**用途**: 網狀網路拓撲信息同步

**訊息數據格式**:
```
┌─────────────┬─────────────┬─────────────┐
│ 節點數量    │ 節點列表    │ 連接信息    │
│ (4 bytes)   │ (變長)      │ (變長)      │
└─────────────┴─────────────┴─────────────┘
```

**節點格式**:
```
┌─────────────┬─────────────┬─────────────┬─────────────┐
│ 節點ID長度  │ 節點 ID     │ 連接數量    │ 連接列表    │
│ (1 byte)    │ (變長)      │ (1 byte)    │ (變長)      │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

### 7. 系統訊息 (system - 0x04)

**用途**: 系統狀態、配置更新

**訊息數據格式**:
```
┌─────────────┬─────────────┬─────────────┐
│ 系統類型    │ 數據長度    │ 系統數據    │
│ (1 byte)    │ (2 bytes)   │ (變長)      │
└─────────────┴─────────────┴─────────────┘
```

### 8. 心跳訊息 (heartbeat - 0x09)

**用途**: 保持連接活躍

**訊息數據格式**:
```
┌─────────────┬─────────────┬─────────────┐
│ 序列號      │ 狀態標誌    │ 負載信息    │
│ (4 bytes)   │ (1 byte)    │ (變長)      │
└─────────────┴─────────────┴─────────────┘
```

---

## 💡 範例說明

### 範例 1: 醫療救助信號

**情境**: 用戶發送醫療救助信號

**原始數據**:
- 信號類型: medical (0x01)
- 發送者: "User123"
- 位置: "台北市信義區"

**完整訊息結構**:
```
01                           // 協議版本 (1)
01                           // 訊息類型 (signal)
24                           // ID長度 (36 bytes for UUID)
366662636665642D636463342D3... // 訊息ID (UUID)
00000015                     // 數據長度 (21 bytes, LE)
60B5E7F5                     // 時間戳 (Unix timestamp, LE)
01                           // 信號類型 (medical)
07                           // 發送者長度 (7)
557365723132334              // 發送者 "User123" (UTF-8)
0F                           // 位置長度 (15)
台北市信義區                  // 位置信息 (UTF-8)
```

### 範例 2: 聊天訊息

**情境**: 用戶發送 "Hello World" 訊息

**原始數據**:
- 發送者: "Alice"
- 設備ID: "Device-001"
- 訊息: "Hello World"

**完整訊息結構**:
```
01                           // 協議版本 (1)
03                           // 訊息類型 (chat)
24                           // ID長度 (36 bytes)
366662636665642D636463342D3... // 訊息ID (UUID)
00000018                     // 數據長度 (24 bytes, LE)
60B5E7F5                     // 時間戳 (Unix timestamp, LE)
05                           // 發送者長度 (5)
416C696365                   // 發送者 "Alice" (UTF-8)
0A                           // 設備ID長度 (10)
4465766963652D303031         // 設備ID "Device-001" (UTF-8)
000B                         // 訊息長度 (11 bytes, LE)
48656C6C6F20576F726C64       // 訊息 "Hello World" (UTF-8)
```

---

## ❌ 錯誤處理

### 解碼錯誤類型

| 錯誤代碼 | 錯誤名稱 | 說明 |
|---------|----------|------|
| `invalidDataSize` | 數據大小無效 | 訊息長度不足或超出限制 |
| `unsupportedVersion` | 不支持的版本 | 協議版本不匹配 |
| `invalidMessageType` | 無效訊息類型 | 未知的訊息類型代碼 |
| `stringDecodingFailed` | 字符串解碼失敗 | UTF-8 解碼錯誤 |
| `corruptedData` | 數據已損壞 | 數據完整性檢查失敗 |

### 錯誤處理策略

1. **格式驗證**:
   - 檢查最小頭部大小 (12 bytes)
   - 驗證協議版本
   - 確認訊息類型有效性

2. **數據完整性**:
   - 驗證聲明長度與實際長度一致
   - 檢查字符串 UTF-8 編碼有效性
   - 確認數據邊界

3. **向後兼容性**:
   - 忽略未知的可選欄位
   - 對未知訊息類型提供警告但不中斷處理
   - 保持版本升級路徑

---

## 🔄 版本控制

### 版本 1.0 (當前)
- 基本 MeshMessage 格式
- 支援 10 種核心訊息類型
- UTF-8 字符串編碼
- Little Endian 字節序

### 未來版本規劃
- **版本 1.1**: 增加壓縮支援
- **版本 1.2**: 增強加密支援
- **版本 2.0**: 可變長度頭部，支援更多訊息類型

---

## 📚 相關文件

- **實作文件**: `BinaryMessageEncoder.swift`, `BinaryMessageDecoder.swift`
- **類型定義**: `SharedTypes.swift`
- **專用協議**: `BinaryProtocol.swift`, `BinaryGameProtocol.swift`
- **錯誤處理**: `BinaryDecodingError`, `BinaryEncodingError`

---

*最後更新: 2025-07-20*  
*版本: 1.0*  
*SignalAir 災難救援通訊系統*