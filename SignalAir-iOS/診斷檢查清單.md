# 🔍 SignalAir 網路診斷檢查清單

## 🎯 測試目標
1. 確認 MCSession 的實際連線狀態
2. 檢測是否有多個 session 實例
3. 分析 stream 和 data 通道的差異
4. 識別哪些操作觸發 channel 錯誤

## 📱 快速測試方法

### 方法 1: 雙模擬器測試
```bash
# 1. 啟動兩個不同的模擬器
xcrun simctl boot "iPhone 16"
xcrun simctl boot "iPad Air"
open -a Simulator

# 2. 在 Xcode 中選擇不同目標設備運行應用程式
# 3. 在兩個模擬器中都打開 SignalAir
# 4. 進入設定 → 點擊 "🔍 網路診斷"
```

### 方法 2: 模擬器 + 實體設備
```bash
# 1. 啟動一個模擬器
xcrun simctl boot "iPhone 16"
open -a Simulator

# 2. 連接實體 iPhone/iPad
# 3. 分別在模擬器和實體設備運行應用程式
# 4. 進行診斷測試
```

## 📊 診斷輸出解讀

### ✅ 正常狀態指標
```
🔍 即時診斷檢查:
- Session 連接數: 1
- Published 連接數: 1  
- 連接狀態一致性: ✅
- 近期是否有錯誤: ✅

📊 NetworkService 診斷報告:
- Session 創建次數: 1
- 當前連接的 Peers: 1 [SignalAir-XXXX]
- Data Channel 使用次數: 5+
- 無記錄的 Channel 錯誤
```

### ⚠️ 異常狀態指標
```
❌ 問題 1: 多個 Session 實例
- Session 創建次數: 3 (應該是 1)
→ 原因: NetworkService 被重複初始化

❌ 問題 2: 連接狀態不一致
- Session 連接數: 2
- Published 連接數: 0
- 連接狀態一致性: ❌
→ 原因: 執行緒競態條件

❌ 問題 3: Channel 錯誤頻發
- 最後錯誤操作: session.send
- 錯誤描述: The operation couldn't be completed
→ 原因: 網路不穩定或數據過大
```

## 🧪 測試場景

### 場景 1: 基本連接測試
1. **啟動兩個設備**
2. **等待自動發現** (30秒內)
3. **運行診斷** → 檢查連接數
4. **預期結果**: 兩設備都顯示 1 個連接

### 場景 2: 訊息傳輸測試  
1. **建立連接**
2. **發送聊天訊息**
3. **運行診斷** → 檢查 Data Channel 使用次數
4. **預期結果**: 使用次數 > 0

### 場景 3: 斷線重連測試
1. **建立連接**
2. **關閉一個設備的 WiFi**
3. **重新開啟 WiFi**
4. **運行診斷** → 檢查是否有 Channel 錯誤
5. **預期結果**: 能夠重新連接

### 場景 4: 多設備穩定性測試
1. **同時啟動 3+ 設備**
2. **觀察連接建立過程**
3. **運行診斷** → 檢查 Session 創建次數
4. **預期結果**: 每設備 Session 創建次數 = 1

## 🚨 常見問題診斷

### 問題: 無法發現其他設備
**檢查項目:**
- [ ] 兩設備都在同一 WiFi 網路
- [ ] 診斷顯示 "Advertiser 狀態: 已初始化"
- [ ] 診斷顯示 "Browser 狀態: 已初始化"

**解決方法:**
```swift
// 在控制台檢查
ServiceContainer.shared.networkService.performQuickDiagnostic()
```

### 問題: 連接建立後立即斷開
**檢查項目:**
- [ ] 診斷顯示是否有 Channel 錯誤
- [ ] Session 連接數是否不穩定
- [ ] Data Channel 使用是否正常

### 問題: 訊息發送失敗
**檢查項目:**
- [ ] Data Channel 使用次數是否增加
- [ ] 是否有 "session.send" 錯誤記錄
- [ ] 連接狀態一致性是否為 ✅

## 📈 效能監控

### 關鍵指標追蹤
```
正常運行的應用程式應顯示:
- Session 創建次數: 1 (每設備)
- Data Channel 使用: 隨訊息增加
- Stream Channel 使用: 0 (暫未使用)
- 連接錯誤: 無或偶發
```

### 異常指標警告
```
需要注意的異常情況:
- Session 創建次數 > 1: 重複初始化
- 連接狀態不一致: 執行緒安全問題  
- 頻繁 Channel 錯誤: 網路或代碼問題
- Data Channel 使用 = 0: 訊息未發送
```

## 💡 診斷技巧

1. **同時檢查兩個設備**: 比較診斷輸出的差異
2. **記錄時間序列**: 觀察指標隨時間的變化
3. **測試極端情況**: 快速開關網路、大量訊息等
4. **驗證一致性**: Session 連接數 = Published 連接數

## 🔧 故障排除步驟

1. **重啟應用程式** → 檢查 Session 創建次數是否重置為 1
2. **重啟網路** → 檢查連接是否重新建立
3. **檢查控制台日誌** → 尋找 🚨 Channel 錯誤標記
4. **比較設備差異** → 確認兩端狀態是否對稱

---

✨ **提示**: 每次測試後記得記錄診斷結果，建立問題模式的資料庫！